---
- name: Create daodao user
  user:
    name: daodao
    comment: 'DaoDao user'
    shell: /usr/sbin/nologin
    groups: ['systemd-journal', 'adm', 'docker']
    state: present

- name: Creates daodao directory
  file:
    path: '/etc/daodao'
    state: directory
    owner: daodao
    group: daodao
    recurse: true
    mode: 0755
  changed_when: false

- name: Clone daodao-notifier github repository
  git:
    repo: https://{{ github_access_token }}@github.com/shifty11/dao-dao-notifier.git
    dest: /etc/daodao/dao-dao-notifier
    clone: yes
    update: yes
    force: yes
  become: yes
  become_user: daodao

# hack because it runs on same server as cosmosgov-bot
- name: Creates web directory
  file:
    path: '/var/www/daodao-notifier'
    state: directory
    owner: caddy
    group: caddy
    recurse: true
  changed_when: false

- name: Create .env file
  template:
    src: '.env.j2'
    dest: '/etc/daodao/dao-dao-notifier/.env'
    owner: root
    group: root
    mode: '644'

- name: Stop and remove previously created containers
  become_user: daodao
  shell:
    cmd: "docker-compose -f production.yml down"
    chdir: /etc/daodao/dao-dao-notifier

- name: Run containers
  become_user: daodao
  shell:
    cmd: "docker-compose -f production.yml up --build -d"
    chdir: /etc/daodao/dao-dao-notifier
